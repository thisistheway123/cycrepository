<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cyc - Calendar</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Calendar-specific overrides kept local */
    .past-day { background: #e0e0e0 !important; color: #aaa !important; cursor: not-allowed !important; }
  .today { background: #fff59d !important; color: #d32f2f !important; border: 2px solid #fbc02d !important; }
  /* Only apply predicted-period visuals when the cell is NOT also today */
  .predicted-period:not(.today) { background: rgba(255,200,200,0.9) !important; color: #7a0000 !important; border: 2px solid #ff8a80 !important; }
    table { width: 90%; max-width: 800px; margin: 0 auto; }
    th { background: purple; color: white; }
    /* Animated calendar and cells */
    .calendar-table { transform-origin: center top; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideInFromRight { from { opacity:0; transform: translateX(18px); } to { opacity:1; transform: translateX(0);} }
    @keyframes slideOutToLeft { from { opacity:1; transform: translateX(0);} to { opacity:0; transform: translateX(-18px);} }
    @keyframes slideInFromLeft { from { opacity:0; transform: translateX(-18px); } to { opacity:1; transform: translateX(0);} }
    @keyframes slideOutToRight { from { opacity:1; transform: translateX(0);} to { opacity:0; transform: translateX(18px);} }

    .anim-in-right { animation: slideInFromRight 360ms cubic-bezier(.2,.9,.3,1) forwards; }
    .anim-out-left { animation: slideOutToLeft 320ms cubic-bezier(.2,.9,.3,1) forwards; }
    .anim-in-left { animation: slideInFromLeft 360ms cubic-bezier(.2,.9,.3,1) forwards; }
    .anim-out-right { animation: slideOutToRight 320ms cubic-bezier(.2,.9,.3,1) forwards; }

    .date-cell { opacity: 0; transform: translateY(6px); }
    @keyframes cellPop { to { opacity: 1; transform: none; } }
    .date-cell.pop { animation: cellPop 360ms cubic-bezier(.2,.9,.3,1) forwards; }

  /* Modal dialog animation */
  /* hidden by default; .open shows it */
  #eventModal { display: none; }
  #eventModal.open { display: flex; }
  #eventDialog { transform: translateY(8px) scale(0.98); opacity: 0; z-index:10001; }
  @keyframes popIn {
    0% { transform: translateY(12px) scale(0.98); opacity: 0; }
    70% { transform: translateY(-6px) scale(1.02); opacity: 1; }
    100% { transform: translateY(0) scale(1); opacity: 1; }
  }
  @keyframes popOut {
    0% { transform: translateY(0) scale(1); opacity: 1; }
    100% { transform: translateY(8px) scale(0.98); opacity: 0; }
  }
  /* helper classes to trigger animations */
  #eventDialog.animate-in { animation: popIn 320ms cubic-bezier(.2,.9,.3,1) forwards; }
  #eventDialog.animate-out { animation: popOut 220ms ease forwards; }
  /* Allow page scroll while modal is open by letting pointer-events pass through the backdrop.
    Dialog itself remains interactive. Backdrop clicks will NOT close the modal (use Cancel/Escape).
  */
  #eventModal { pointer-events: none; }
  #eventModal.open { pointer-events: none; }
  #eventModal.open #eventDialog { pointer-events: auto; max-height: 80vh; overflow: auto; }
  </style>
</head>
<body>
  <header>
    <nav class="nav-bar">
      <div class="logo">
      <img src="cyclogo (1) (1).png" alt="  ts Logo" class="logo-img">
      </div>
      <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="about.html">About</a>
        <a href="calendar.html">Calendar</a>
        <a href="index.html?editSurvey=1" title="Edit your menstrual survey">Edit Survey</a>
      </div>
      <div id="clock-header" style="margin-left:auto; font-size:1.3em; font-weight:bold; color:#fff; background:#333; border-radius:8px; padding:10px 30px; min-width:100px; text-align:center;"></div>
      <div class="menu-toggle">☰</div>
    </nav>
  </header>

  <div style="display:flex;justify-content:center;align-items:center;margin:20px 0;gap:20px;">
    <button id="prevMonthBtn">&#8592; Prev</button>
    <h2 id="calendarTitle" style="color: rgb(0, 0, 0);margin:0;"></h2>
    <button id="nextMonthBtn">Next &#8594;</button>
  </div>
  <div id="calendarContainer"></div>

  <script>
    function updateClockHeader() {
      const now = new Date();
      let h = now.getHours().toString().padStart(2, '0');
      let m = now.getMinutes().toString().padStart(2, '0');
      let s = now.getSeconds().toString().padStart(2, '0');
      document.getElementById('clock-header').textContent = `${h}:${m}:${s}`;
    }
    setInterval(updateClockHeader, 1000);
    updateClockHeader();
  </script>
  <footer>

    <div>© 2025 Cyc. All rights reserved.</div>
  </footer>
  <div id="eventModal" style="position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;" aria-hidden="true" role="dialog" aria-modal="true">
    <div id="eventDialog" style="background:#fff; padding:24px; border-radius:8px; min-width:300px; max-width:90vw; margin:auto; position:relative;">
      <h3 id="modalDate"></h3>
      <input id="eventInput" type="text" placeholder="Enter event..." style="width:100%; margin-bottom:10px; padding:6px;" />
      <input id="fileInput" type="file" accept=".txt" style="margin-bottom:10px;" />
      <div style="margin-bottom:10px; color:#888; font-size:0.9em;">Or select a .txt file to display its contents.</div>
      <button id="saveEventBtn">Save</button>
      <button id="cancelEventBtn">Cancel</button>
    </div>
  </div>
  <script>
    // Calendar logic with animated transitions
    const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    const today = new Date();
    let viewMonth = today.getMonth();
    let viewYear = today.getFullYear();

    const calendarTitle = document.getElementById('calendarTitle');
    const calendarContainer = document.getElementById('calendarContainer');

    const modal = document.getElementById('eventModal');
    const eventDialog = document.getElementById('eventDialog');
    const eventInput = document.getElementById('eventInput');
    const fileInput = document.getElementById('fileInput');
    const saveBtn = document.getElementById('saveEventBtn');
    const cancelBtn = document.getElementById('cancelEventBtn');
    const modalDate = document.getElementById('modalDate');
    let currentEntries = null;
    let currentDate = null;

    // build a table element for the given month/year (doesn't attach)
    function buildCalendar(month, year) {
      calendarTitle.textContent = `${monthNames[month]} ${year}`;
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      // Load menstrual data (if any) from localStorage
      let menstrualData = null;
      try { menstrualData = JSON.parse(localStorage.getItem('menstrualData') || 'null'); } catch(e) { menstrualData = null; }
      const msPerDay = 24*60*60*1000;
      function isPredictedPeriod(dateObj) {
        if (!menstrualData || !menstrualData.lastStart) return false;
        const cycle = parseInt(menstrualData.cycleLength,10) || 28;
        const period = parseInt(menstrualData.periodLength,10) || 5;
        const last = new Date(menstrualData.lastStart + 'T00:00:00');
        const diff = Math.floor((dateObj - last) / msPerDay);
        const mod = ((diff % cycle) + cycle) % cycle;
        return mod >= 0 && mod < period;
      }

      const table = document.createElement('table');
      table.className = 'calendar-table';
      table.setAttribute('bgcolor','lightgrey');
      table.setAttribute('cellspacing','21');
      table.setAttribute('cellpadding','21');

      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => { const th = document.createElement('th'); th.textContent = d; headRow.appendChild(th); });
      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      let date = 1;
      let seq = 0; // for staggering
      for (let i = 0; i < 6; i++) {
        const row = document.createElement('tr');
        for (let j = 0; j < 7; j++) {
          const cell = document.createElement('td');
          if (i === 0 && j < firstDay) {
            // empty cell
          } else if (date > daysInMonth) {
            // empty
          } else {
            const dateDiv = document.createElement('div');
            dateDiv.className = 'date-number';
            dateDiv.textContent = date;
            const entriesDiv = document.createElement('div');
            entriesDiv.className = 'entries';
            cell.appendChild(dateDiv);
            cell.appendChild(entriesDiv);

            // mark predicted period
            const cellDateObj = new Date(year, month, date);
            if (isPredictedPeriod(cellDateObj)) cell.classList.add('predicted-period');

            // mark past/today
            if (year < today.getFullYear() || (year === today.getFullYear() && month < today.getMonth()) || (year === today.getFullYear() && month === today.getMonth() && date < today.getDate())) {
              cell.classList.add('past-day');
            } else if (year === today.getFullYear() && month === today.getMonth() && date === today.getDate()) {
              cell.classList.add('today');
            }

            // animation: staggered pop using rAF to avoid piling up timers
            cell.classList.add('date-cell');
            // small stagger based on sequence
            cell.style.animationDelay = `${seq * 32}ms`;
            // use rAF chain to schedule pop without many timeouts
            (function(c, s){
              requestAnimationFrame(() => {
                // next frame allow computed style to settle then add pop
                requestAnimationFrame(() => c.classList.add('pop'));
              });
            })(cell, seq);
            seq++;

            date++;
          }
          row.appendChild(cell);
        }
        tbody.appendChild(row);
        if (date > daysInMonth) break;
      }

      table.appendChild(tbody);

      // Attach click listeners for each date cell
      table.querySelectorAll('td').forEach(cell => {
        const dateNumber = cell.querySelector('.date-number');
        if (!dateNumber) return;
        cell.addEventListener('click', () => {
          console.log('calendar cell clicked:', dateNumber.textContent, month, year);
          if (cell.classList.contains('past-day')) return;
          const entries = cell.querySelector('.entries');
          if (dateNumber && entries) {
            currentEntries = entries;
            currentDate = dateNumber.textContent;
            eventInput.value = entries.textContent || '';
            fileInput.value = '';
            modalDate.textContent = `Event for ${monthNames[month]} ${currentDate}, ${year}`;
            // show modal with animation
            showModal();
          }
        });
      });

      return table;
    }

    // Swap current calendar with new one using directional animation
    function showCalendar(month, year, dir) {
      const newTable = buildCalendar(month, year);
      // dir: -1 = left (previous), +1 = right (next), 0 = none
      if (!calendarContainer.firstElementChild) {
        // initial
        calendarContainer.appendChild(newTable);
        return;
      }
      const old = calendarContainer.firstElementChild;
      if (dir === 1) {
        newTable.classList.add('anim-in-right');
        old.classList.add('anim-out-left');
        calendarContainer.appendChild(newTable);
      } else if (dir === -1) {
        newTable.classList.add('anim-in-left');
        old.classList.add('anim-out-right');
        calendarContainer.appendChild(newTable);
      } else {
        // no directional animation - simple replace with fadeInUp
        newTable.style.animation = 'fadeInUp 300ms ease forwards';
        calendarContainer.appendChild(newTable);
        old.remove();
        return;
      }

      // remove old after its animation ends
      old.addEventListener('animationend', () => {
        if (old && old.parentNode) old.parentNode.removeChild(old);
      }, { once: true });
    }

    let previousFocus = null;
    function showModal() {
      console.log('showModal called');
      previousFocus = document.activeElement;
  modal.classList.add('open');
  modal.setAttribute('aria-hidden','false');
  // do not disable body scrolling; keep overlay pointer-events none so background scroll works
  modal.style.zIndex = 99999;
      // ensure no leftover classes
      eventDialog.classList.remove('animate-out');
      // animate in
      eventDialog.classList.add('animate-in');
      // focus when animation finishes
      eventDialog.addEventListener('animationend', function onEnd() {
        eventDialog.removeEventListener('animationend', onEnd);
        try { eventInput.focus(); } catch(e){}
      });
    }

    function hideModal() {
  modal.setAttribute('aria-hidden','true');
      // animate out
      eventDialog.classList.remove('animate-in');
      eventDialog.classList.add('animate-out');
      eventDialog.addEventListener('animationend', function onClose() {
        eventDialog.removeEventListener('animationend', onClose);
  modal.classList.remove('open');
  try { if (previousFocus && previousFocus.focus) previousFocus.focus(); } catch(e){}
      });
    }

    // close modal on Escape for robustness
    document.addEventListener('keydown', (ev) => {
      if (ev.key === 'Escape' && modal.classList.contains('open')) {
        hideModal();
      }
    });

    document.getElementById('prevMonthBtn').addEventListener('click', () => {
      viewMonth--;
      if (viewMonth < 0) { viewMonth = 11; viewYear--; }
      showCalendar(viewMonth, viewYear, -1);
    });
    document.getElementById('nextMonthBtn').addEventListener('click', () => {
      viewMonth++;
      if (viewMonth > 11) { viewMonth = 0; viewYear++; }
      showCalendar(viewMonth, viewYear, 1);
    });

    saveBtn.addEventListener('click', () => {
      if (currentEntries) currentEntries.textContent = eventInput.value;
      hideModal();
    });
    cancelBtn.addEventListener('click', () => { hideModal(); });
    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file && file.type === 'text/plain') {
        const reader = new FileReader();
        reader.onload = evt => { eventInput.value = evt.target.result; };
        reader.readAsText(file);
      }
    });
    modal.addEventListener('click', e => { if (e.target === modal) hideModal(); });

    // initial render
    showCalendar(viewMonth, viewYear, 0);
  </script>
  <script src="script.js"></script>

</body>
</html>